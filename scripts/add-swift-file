#!/usr/bin/env ruby

# Adds a Swift file to the ChecklistApp Xcode project
# Usage: ./scripts/add-swift-file MyNewFile.swift
#
# Requires: gem install xcodeproj

require 'xcodeproj'

input = ARGV[0]

if input.nil? || input.empty?
  puts "Usage: #{$0} <filename.swift>"
  puts "Examples:"
  puts "  #{$0} NewFeature.swift"
  exit 1
end

unless input.end_with?('.swift')
  puts "Error: File must be a .swift file"
  exit 1
end

filename = input
group_name = 'iOSApp'
target_name = 'ChecklistApp'

project_path = File.join(__dir__, '..', 'ios', 'ChecklistApp.xcodeproj')
file_path = File.join(__dir__, '..', 'ios', group_name, filename)

unless File.exist?(project_path)
  puts "Error: Project not found at #{project_path}"
  exit 1
end

unless File.exist?(file_path)
  puts "Error: File not found at #{file_path}"
  puts "Create the file first, then run this script to add it to the project."
  exit 1
end

project = Xcodeproj::Project.open(project_path)

# Find the group
group = project.main_group.find_subpath(group_name, false)

if group.nil?
  puts "Error: Could not find #{group_name} group"
  exit 1
end

# Check if this is a filesystem-synced group (Xcode 15+)
if group.is_a?(Xcodeproj::Project::Object::PBXFileSystemSynchronizedRootGroup)
  puts "#{group_name} uses filesystem sync - file will be auto-detected by Xcode"
  puts "File exists at: #{file_path}"
  exit 0
end

# Traditional PBXGroup handling
target = project.targets.find { |t| t.name == target_name }

if target.nil?
  puts "Error: Could not find #{target_name} target"
  exit 1
end

# Check if file already exists in project
existing = group.files.find { |f| f.path == filename }
if existing
  puts "File #{filename} is already in the project"
  exit 0
end

# Add file reference to group
file_ref = group.new_file(filename)

# Add to sources build phase
target.source_build_phase.add_file_reference(file_ref)

project.save

puts "Added #{filename} to #{target_name} target in #{group_name} group"
